<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Student Dashboard | Quiz Master</title>

<style>
:root {
    --bg-main: #0d1117;
    --bg-card: #161b22;
    --border: #30363d;
    --text-main: #c9d1d9;
    --text-white: #f0f6fc;
    --green: #238636;
    --green-hover: #2ea043;
    --accent: #58a6ff;
}

body {
    background: var(--bg-main);
    color: var(--text-main);
    font-family: sans-serif;
    margin: 0;
    padding: 0;
}

.container {
    max-width: 900px;
    margin: 50px auto;
    padding: 20px;
}

h1 {
    color: var(--text-white);
    margin-bottom: 25px;
}

.card {
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 20px;
}

select, button {
    width: 100%;
    padding: 10px;
    margin-top: 10px;
    border-radius: 6px;
    border: 1px solid var(--border);
    background: var(--bg-main);
    color: var(--text-white);
}

button {
    cursor: pointer;
    background: var(--green);
}

button:hover {
    background: var(--green-hover);
}

button:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}
</style>
</head>

<body>
<div class="container">

    <h1>Welcome, {{ session['user_name'] }}</h1>

    <!-- SUBJECT -->
    <div class="card">
        <h3>Select Subject</h3>
        <select id="subject-select">
            <option value="">-- Select Subject --</option>
        </select>
    </div>

    <!-- CHAPTER -->
    <div class="card">
        <h3>Select Chapter</h3>
        <select id="chapter-select" disabled>
            <option value="">-- Select Chapter --</option>
        </select>
    </div>

    <!-- QUIZ -->
    <div class="card">
        <h3>Select Quiz</h3>
        <select id="quiz-select" disabled>
            <option value="">-- Select Quiz --</option>
        </select>
        <button id="start-quiz" disabled>Start Quiz</button>
    </div>

</div>

<script>
// ---------------- API HELPER ----------------
async function api(url, method='GET', data=null) {
    return fetch(url, {
        method,
        headers: { 'Content-Type': 'application/json' },
        body: data ? JSON.stringify(data) : null
    });
}

// ---------------- LOAD SUBJECTS ----------------
async function loadSubjects() {
    const res = await api('/api/subjects');
    const subjects = await res.json();

    const subjectSelect = document.getElementById('subject-select');
    subjects.forEach(s => {
        subjectSelect.innerHTML += `<option value="${s.id}">${s.name}</option>`;
    });
}

// ---------------- SUBJECT CHANGE ----------------
document.getElementById('subject-select').addEventListener('change', async function () {
    const subjectId = this.value;

    const chapterSelect = document.getElementById('chapter-select');
    const quizSelect = document.getElementById('quiz-select');
    const startBtn = document.getElementById('start-quiz');

    chapterSelect.innerHTML = `<option value="">-- Select Chapter --</option>`;
    quizSelect.innerHTML = `<option value="">-- Select Quiz --</option>`;
    chapterSelect.disabled = true;
    quizSelect.disabled = true;
    startBtn.disabled = true;

    if (!subjectId) return;

    const res = await api('/api/subjects');
    const subjects = await res.json();
    const subject = subjects.find(s => s.id == subjectId);

    subject.chapters.forEach(c => {
        chapterSelect.innerHTML += `<option value="${c.id}">${c.name}</option>`;
    });

    chapterSelect.disabled = false;
});

// ---------------- CHAPTER CHANGE ----------------
document.getElementById('chapter-select').addEventListener('change', async function () {
    const chapterId = this.value;

    const quizSelect = document.getElementById('quiz-select');
    const startBtn = document.getElementById('start-quiz');

    quizSelect.innerHTML = `<option value="">-- Select Quiz --</option>`;
    quizSelect.disabled = true;
    startBtn.disabled = true;

    if (!chapterId) return;

    const res = await api('/api/subjects');
    const subjects = await res.json();

    let quizzes = [];
    subjects.forEach(s => {
        s.chapters.forEach(c => {
            if (c.id == chapterId) quizzes = c.quizzes;
        });
    });

    quizzes.forEach(q => {
        quizSelect.innerHTML += `<option value="${q.id}">${q.name}</option>`;
    });

    quizSelect.disabled = false;
});

// ---------------- QUIZ CHANGE ----------------
document.getElementById('quiz-select').addEventListener('change', function () {
    document.getElementById('start-quiz').disabled = !this.value;
});

// ---------------- START QUIZ (REDIRECT) ----------------
document.getElementById('start-quiz').addEventListener('click', function () {
    const quizId = document.getElementById('quiz-select').value;
    if (!quizId) return;

    // âœ… Redirect to quiz page
    window.location.href = `/student_quiz.html?quiz_id=${quizId}`;
});

// INIT
loadSubjects();
</script>

</body>
</html>
