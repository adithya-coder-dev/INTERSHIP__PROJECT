<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Student Dashboard | Quiz Master</title>
<style>
:root {
    --bg-main: #0d1117;
    --bg-card: #161b22;
    --border: #30363d;
    --text-main: #c9d1d9;
    --text-muted: #8b949e;
    --text-white: #f0f6fc;
    --green: #238636;
    --green-hover: #2ea043;
    --accent: #58a6ff;
    --transition: 0.3s ease;
}
* { margin:0; padding:0; box-sizing:border-box; font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Helvetica,Arial,sans-serif; }
body { display:flex; min-height:100vh; background:var(--bg-main); color:var(--text-main); }
.sidebar { width:300px; background:var(--bg-card); border-right:1px solid var(--border); display:flex; flex-direction:column; padding:20px; overflow-y:auto; }
.sidebar h2 { color:var(--text-white); font-size:22px; text-align:center; margin-bottom:20px; }
.menu-item { display:flex; justify-content:space-between; align-items:center; padding:12px 15px; cursor:pointer; border-radius:8px; margin-bottom:5px; transition:background var(--transition); }
.menu-item:hover { background: var(--border); }
.sub-menu { padding-left:15px; display:none; flex-direction:column; }
.menu-item.active + .sub-menu { display:flex; flex-direction:column; }
.button { background:var(--green); color:var(--text-white); padding:6px 12px; border:none; border-radius:6px; cursor:pointer; font-size:13px; margin:3px 0; transition:background var(--transition); }
.button:hover { background: var(--green-hover); }
.main-content { flex:1; padding:40px; overflow-y:auto; }
.main-content h1 { font-size:28px; color:var(--text-white); margin-bottom:20px; }
.card { background:var(--bg-card); border:1px solid var(--border); border-radius:12px; padding:25px; margin-bottom:20px; transition:transform var(--transition); }
.card:hover { transform:translateY(-3px); }
select, input[type=radio] { margin-bottom:10px; }
.footer { padding:20px; text-align:center; font-size:13px; color:var(--text-muted); border-top:1px solid var(--border); }
.overview { margin-bottom:15px; display:flex; flex-wrap:wrap; gap:5px; }
.overview .button { width:35px; padding:5px; font-size:12px; }
</style>
</head>
<body>

<div class="sidebar">
    <h2>Quiz Master</h2>

    <div class="menu-item" onclick="toggleMenu(this)">Take Quiz</div>
    <div class="sub-menu">
        <select id="subject-select" onchange="loadChapters()"><option value="">Select Subject</option></select>
        <select id="chapter-select" onchange="loadQuizzes()"><option value="">Select Chapter</option></select>
        <select id="quiz-select"><option value="">Select Quiz</option></select>
        <button class="button" onclick="startQuiz()">Start Quiz</button>
    </div>

    <div class="menu-item" onclick="toggleMenu(this)">My Scores</div>
    <div class="sub-menu">
        <button class="button" onclick="viewScores()">View My Scores</button>
        <div id="score-list"></div>
    </div>
</div>

<div class="main-content" id="main-content">
    <h1>Welcome, {{ session['user_name'] }}</h1>
    <div id="content-area">
        <div class="card"><p>Select a quiz from the sidebar to start.</p></div>
    </div>
</div>

<div class="footer">© 2025 Quiz Master · Student Panel · Modern Dashboard</div>

<script>
// ----------------- API -----------------
async function api(url, method='GET', data=null){
    return await fetch(url,{method,headers:{'Content-Type':'application/json'},body:data?JSON.stringify(data):null});
}

// ----------------- Menu Toggle -----------------
function toggleMenu(el){ el.classList.toggle('active'); const submenu = el.nextElementSibling; submenu.style.display = submenu.style.display==='flex'?'none':'flex'; }

// ----------------- Load Subjects/Chapters/Quizzes -----------------
async function loadSubjects(){
    const res = await api('/api/subjects');
    const subjects = await res.json();
    const sel = document.getElementById('subject-select');
    sel.innerHTML='<option value="">Select Subject</option>';
    subjects.forEach(s => sel.innerHTML += `<option value="${s.id}">${s.name}</option>`);
}

async function loadChapters(){
    const subjId = document.getElementById('subject-select').value;
    const chapSel = document.getElementById('chapter-select');
    const quizSel = document.getElementById('quiz-select');
    chapSel.innerHTML='<option value="">Select Chapter</option>';
    quizSel.innerHTML='<option value="">Select Quiz</option>';
    if(!subjId) return;
    const res = await api(`/api/subjects/${subjId}`);
    const data = await res.json();
    (data.chapters || []).forEach(c => chapSel.innerHTML += `<option value="${c.id}">${c.name}</option>`);
}

async function loadQuizzes(){
    const chapId = document.getElementById('chapter-select').value;
    const quizSel = document.getElementById('quiz-select');
    quizSel.innerHTML='<option value="">Select Quiz</option>';
    if(!chapId) return;
    const res = await api(`/api/chapters/${chapId}`);
    const data = await res.json();
    (data.quizzes || []).forEach(q => quizSel.innerHTML += `<option value="${q.id}">${q.name}</option>`);
}

// ----------------- SPA Quiz Logic -----------------
let currentQuiz = [];
let currentQuizId = null;
let currentQuestionIndex = 0;

async function startQuiz(){
    const quizId = document.getElementById('quiz-select').value;
    if(!quizId){ alert('Select a quiz'); return; }
    const res = await api(`/api/quizzes/${quizId}/questions`);
    const questions = await res.json();
    if(questions.length===0){ alert('No questions in this quiz'); return; }
    currentQuiz = questions.map(q => ({...q, userAnswer: null}));
    currentQuizId = quizId;
    currentQuestionIndex = 0;
    showQuestion(currentQuestionIndex);
}

function showQuestion(index){
    const content = document.getElementById('content-area');
    const q = currentQuiz[index];
    const total = currentQuiz.length;

    let overviewHTML = `<div class="overview">`;
    currentQuiz.forEach((q2,i)=>{
        overviewHTML += `<button class="button" style="background:${q2.userAnswer ? 'var(--green)' : 'var(--accent)'}" onclick="jumpQuestion(${i})">${i+1}</button>`;
    });
    overviewHTML += `</div>`;

    let html = overviewHTML + `<div class="card">
        <p><strong>Question ${index+1} / ${total}</strong></p>
        <p>${q.text}</p>`;
    q.options.forEach((opt,i)=>{
        const checked = q.userAnswer===i+1 ? 'checked' : '';
        html += `<div><label><input type="radio" name="q${q.id}" value="${i+1}" ${checked}> ${opt}</label></div>`;
    });
    html += `<div style="margin-top:10px;">`;
    if(index>0) html += `<button class="button" onclick="prevQuestion()">Previous</button>`;
    if(index<total-1) html += `<button class="button" onclick="nextQuestion()">Next</button>`;
    else html += `<button class="button" onclick="submitQuiz()">Submit Quiz</button>`;
    html += `</div></div>`;
    content.innerHTML = html;
}

function saveAnswer(){
    const q = currentQuiz[currentQuestionIndex];
    const selected = document.querySelector(`input[name="q${q.id}"]:checked`);
    q.userAnswer = selected ? parseInt(selected.value) : null;
}

function nextQuestion(){ saveAnswer(); currentQuestionIndex++; showQuestion(currentQuestionIndex); }
function prevQuestion(){ saveAnswer(); currentQuestionIndex--; showQuestion(currentQuestionIndex); }
function jumpQuestion(idx){ saveAnswer(); currentQuestionIndex = idx; showQuestion(idx); }

async function submitQuiz(){
    saveAnswer();
    const answers = {};
    currentQuiz.forEach(q => { if(q.userAnswer) answers[`q${q.id}`] = q.userAnswer; });
    const res = await api(`/api/quizzes/${currentQuizId}/submit`, 'POST', {answers});
    const result = await res.json();
    alert(`You scored: ${result.score} / ${result.total}`);
    document.getElementById('content-area').innerHTML = `<div class="card">Select a quiz from the sidebar to start.</div>`;
    currentQuiz = []; currentQuizId = null; currentQuestionIndex = 0;
}

// ----------------- View Scores -----------------
async function viewScores(){
    const res = await api(`/api/student/scores`);
    const scores = await res.json();
    const list = document.getElementById('score-list');
    list.innerHTML='';
    scores.forEach(s=>{
        const div = document.createElement('div');
        div.classList.add('card');
        div.innerHTML=`<strong>${s.quiz_name}</strong> (${s.subject_name} > ${s.chapter_name})<br>Score: ${s.score} / ${s.total}`;
        list.appendChild(div);
    });
}

// ----------------- Init -----------------
loadSubjects();
</script>

</body>
</html>
