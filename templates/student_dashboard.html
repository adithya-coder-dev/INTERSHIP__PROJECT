<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Student Dashboard | Quiz Master</title>
<style>
:root {
    --bg-main: #0d1117;
    --bg-card: #161b22;
    --border: #30363d;
    --text-main: #c9d1d9;
    --text-white: #f0f6fc;
    --green: #238636;
    --green-hover: #2ea043;
    --accent: #58a6ff;
    --transition: 0.3s ease;
}
body { background: var(--bg-main); color: var(--text-main); font-family: sans-serif; margin:0; padding:0; }
.container { max-width: 900px; margin: 50px auto; padding:20px; }
h1 { color: var(--text-white); margin-bottom: 25px; }
.card { background: var(--bg-card); border:1px solid var(--border); border-radius:12px; padding:20px; margin-bottom:20px; }
select, button { width:100%; padding:10px; margin-top:10px; border-radius:6px; border:1px solid var(--border); background:var(--bg-main); color:var(--text-white); }
button { cursor:pointer; background: var(--green); transition:0.3s; }
button:hover { background: var(--green-hover); }
#quiz-area { margin-top:20px; }
.question-card { background:#1e2228; padding:15px; border-radius:8px; margin-bottom:15px; }
.question-card input[type="radio"] { margin-right:10px; }
#submit-quiz { margin-top:15px; }
</style>
</head>
<body>
<div class="container">
    <h1>Welcome, {{ session['user_name'] }}</h1>

    <div class="card">
        <h3>Select Subject</h3>
        <select id="subject-select">
            <option value="">--Select Subject--</option>
        </select>
    </div>

    <div class="card">
        <h3>Select Chapter</h3>
        <select id="chapter-select" disabled>
            <option value="">--Select Chapter--</option>
        </select>
    </div>

    <div class="card">
        <h3>Select Quiz</h3>
        <select id="quiz-select" disabled>
            <option value="">--Select Quiz--</option>
        </select>
        <button id="start-quiz" disabled>Start Quiz</button>
    </div>

    <div id="quiz-area"></div>
</div>

<script>
// ---------------- API ----------------
async function api(url, method='GET', data=null){
    return await fetch(url,{method,headers:{'Content-Type':'application/json'},body:data?JSON.stringify(data):null});
}

// ---------------- Load Subjects ----------------
async function loadSubjects(){
    const res = await api('/api/subjects');
    const subjects = await res.json();
    const sel = document.getElementById('subject-select');
    subjects.forEach(s => { sel.innerHTML += `<option value="${s.id}">${s.name}</option>`; });
}

document.getElementById('subject-select').addEventListener('change', async function(){
    const subjectId = this.value;
    const chapterSelect = document.getElementById('chapter-select');
    chapterSelect.innerHTML = `<option value="">--Select Chapter--</option>`;
    document.getElementById('quiz-select').innerHTML = `<option value="">--Select Quiz--</option>`;
    document.getElementById('quiz-select').disabled = true;
    document.getElementById('start-quiz').disabled = true;
    if(!subjectId) return;
    const res = await api('/api/subjects');
    const subjects = await res.json();
    const subject = subjects.find(s=>s.id==subjectId);
    subject.chapters.forEach(c=>{ chapterSelect.innerHTML += `<option value="${c.id}">${c.name}</option>`; });
    chapterSelect.disabled = false;
});

document.getElementById('chapter-select').addEventListener('change', async function(){
    const chapterId = this.value;
    const quizSelect = document.getElementById('quiz-select');
    quizSelect.innerHTML = `<option value="">--Select Quiz--</option>`;
    document.getElementById('start-quiz').disabled = true;
    if(!chapterId) return;
    const res = await api('/api/subjects');
    const subjects = await res.json();
    let quizzes = [];
    subjects.forEach(s=>s.chapters.forEach(c=>{
        if(c.id==chapterId) quizzes=c.quizzes;
    }));
    quizzes.forEach(q=>{ quizSelect.innerHTML += `<option value="${q.id}">${q.name}</option>`; });
    quizSelect.disabled = false;
});

document.getElementById('quiz-select').addEventListener('change', function(){
    document.getElementById('start-quiz').disabled = !this.value;
});

// ---------------- Start Quiz ----------------
document.getElementById('start-quiz').addEventListener('click', async function(){
    const quizId = document.getElementById('quiz-select').value;
    if(!quizId) return;
    const res = await api(`/api/quizzes/${quizId}/questions`);
    const questions = await res.json();
    const quizArea = document.getElementById('quiz-area');
    quizArea.innerHTML = '';
    questions.forEach((q,idx)=>{
        const div = document.createElement('div');
        div.classList.add('question-card');
        let optionsHTML = '';
        q.options.forEach((opt,i)=>{
            optionsHTML += `<label><input type="radio" name="q${q.id}" value="${i+1}"> ${opt}</label><br>`;
        });
        div.innerHTML = `<p><strong>Q${idx+1}:</strong> ${q.text}</p>${optionsHTML}`;
        quizArea.appendChild(div);
    });
    if(questions.length>0){
        const submitBtn = document.createElement('button');
        submitBtn.id='submit-quiz';
        submitBtn.textContent='Submit Quiz';
        submitBtn.onclick = ()=>submitQuiz(quizId, questions);
        quizArea.appendChild(submitBtn);
    }
});

// ---------------- Submit Quiz ----------------
async function submitQuiz(quizId, questions){
    const answers = questions.map(q=>{
        const selected = document.querySelector(`input[name="q${q.id}"]:checked`);
        return {question_id: q.id, answer: selected?parseInt(selected.value):null};
    });
    if(answers.some(a=>a.answer===null)){ alert('Please answer all questions'); return; }

    // Send results to backend (implement /api/results POST in Flask)
    await api('/api/results','POST',{quiz_id: quizId, answers});
    alert('Quiz submitted successfully!');
    document.getElementById('quiz-area').innerHTML='';
}

loadSubjects();
</script>
</body>
</html>
